<footer class="mt-auto border-t border-white/10 bg-[#060a12]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div>
        <div class="flex items-center gap-2 mb-3">
          <div class="w-8 h-8 bg-gradient-to-br from-secondary to-accent rounded-lg flex items-center justify-center font-bold text-primary text-sm">B</div>
          <span class="font-bold text-lg">BILYABITS<span class="text-secondary">-RAPI</span></span>
        </div>
        <p class="text-gray-400 text-sm">Open source REST API platform. Build, test, and deploy APIs effortlessly.</p>
      </div>
      <div>
        <h4 class="font-semibold text-sm mb-3 text-secondary">Quick Links</h4>
        <div class="space-y-2">
          <a href="/" class="block text-sm text-gray-400 hover:text-white transition">Home</a>
          <a href="/login" class="block text-sm text-gray-400 hover:text-white transition">Login</a>
          <a href="/register" class="block text-sm text-gray-400 hover:text-white transition">Register</a>
        </div>
      </div>
      <div>
        <h4 class="font-semibold text-sm mb-3 text-secondary">Socials</h4>
        <div class="space-y-2">
          <a href="<%= config.socials['repo-loc'] %>" target="_blank" class="block text-sm text-gray-400 hover:text-white transition">GitHub</a>
          <a href="<%= config.socials.facebook %>" target="_blank" class="block text-sm text-gray-400 hover:text-white transition">Facebook</a>
          <a href="<%= config.socials.telegram %>" target="_blank" class="block text-sm text-gray-400 hover:text-white transition">Telegram</a>
        </div>
      </div>
    </div>
    <div class="border-t border-white/10 mt-8 pt-6 text-center">
      <p class="text-gray-500 text-xs">&copy; <%= new Date().getFullYear() %> BILYABITS-RAPI by <%= config.ownerName %>. All rights reserved.</p>
    </div>
  </div>
</footer>
<script>
(function() {
  const toggle = document.getElementById('mobileToggle');
  const drawer = document.getElementById('sideDrawer');
  const overlay = document.getElementById('drawerOverlay');
  const closeBtn = document.getElementById('drawerClose');

  function openDrawer() {
    drawer.classList.remove('-translate-x-full');
    overlay.classList.remove('hidden');
    requestAnimationFrame(() => overlay.classList.remove('opacity-0'));
    document.body.style.overflow = 'hidden';
  }
  function closeDrawer() {
    drawer.classList.add('-translate-x-full');
    overlay.classList.add('opacity-0');
    setTimeout(() => overlay.classList.add('hidden'), 300);
    document.body.style.overflow = '';
  }

  toggle?.addEventListener('click', openDrawer);
  closeBtn?.addEventListener('click', closeDrawer);
  overlay?.addEventListener('click', closeDrawer);

  document.querySelectorAll('.drawer-dropdown-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const content = btn.nextElementSibling;
      content.classList.toggle('hidden');
      btn.querySelector('svg').classList.toggle('rotate-180');
    });
  });

  function handleApiLinkClick(e) {
    e.preventDefault();
    const apiName = e.currentTarget.dataset.apiName;
    closeDrawer();
    <% if (typeof user !== 'undefined' && user) { %>
      const dashUrl = '/user/<%= user.username %>?autoselect=' + encodeURIComponent(apiName);
      if (window.location.pathname === '/user/<%= user.username %>') {
        window.autoSelectApi(apiName);
      } else {
        window.location.href = dashUrl;
      }
    <% } else { %>
      window.location.href = '/login';
    <% } %>
  }

  document.querySelectorAll('.drawer-api-link, .desktop-api-link').forEach(link => {
    link.addEventListener('click', handleApiLinkClick);
  });

  const notifToggle = document.getElementById('notifToggle');
  const notifPanel = document.getElementById('notifPanel');
  if (notifToggle && notifPanel) {
    notifToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      notifPanel.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
      if (!notifPanel.contains(e.target) && e.target !== notifToggle && !notifToggle.contains(e.target)) {
        notifPanel.classList.add('hidden');
      }
    });

    const notifList = document.getElementById('notifList');
    const notifBadge = document.getElementById('notifBadge');
    const notifEmpty = document.getElementById('notifEmpty');
    const markAllBtn = document.getElementById('markAllRead');

    async function fetchNotifications() {
      try {
        const resp = await fetch('/api/notifications');
        if (!resp.ok) return;
        const data = await resp.json();
        const unread = data.filter(n => !n.is_read).length;
        if (unread > 0) {
          notifBadge.textContent = unread > 9 ? '9+' : unread;
          notifBadge.classList.remove('hidden');
        } else {
          notifBadge.classList.add('hidden');
        }
        if (data.length === 0) {
          notifEmpty.classList.remove('hidden');
          notifList.innerHTML = '';
          notifList.appendChild(notifEmpty);
          return;
        }
        notifEmpty.classList.add('hidden');
        const existingEmpty = notifList.querySelector('#notifEmpty');
        notifList.innerHTML = '';
        data.forEach(n => {
          const div = document.createElement('div');
          div.className = 'p-3 rounded-xl text-sm transition cursor-pointer hover:bg-white/10 ' + (n.is_read ? 'bg-white/5 text-gray-400' : 'bg-secondary/10 border border-secondary/20 text-white');
          div.innerHTML = `
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-xs ${n.is_read ? 'text-gray-400' : 'text-secondary'}">${escapeHtml(n.title)}</p>
                <p class="text-xs mt-1 ${n.is_read ? 'text-gray-500' : 'text-gray-300'} line-clamp-2">${escapeHtml(n.message)}</p>
                <p class="text-[10px] text-gray-500 mt-1">${timeAgo(n.created_at)}</p>
              </div>
              ${!n.is_read ? '<span class="w-2 h-2 bg-secondary rounded-full flex-shrink-0 mt-1"></span>' : ''}
            </div>
          `;
          div.addEventListener('click', () => openNotifModal(n));
          notifList.appendChild(div);
        });
      } catch(e) {}
    }

    async function markRead(id) {
      try {
        await fetch('/api/notifications/' + id + '/read', { method: 'POST' });
        fetchNotifications();
      } catch(e) {}
    }

    markAllBtn?.addEventListener('click', async () => {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        fetchNotifications();
      } catch(e) {}
    });

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text;
      return d.innerHTML;
    }

    function timeAgo(dateStr) {
      const now = Date.now();
      const then = new Date(dateStr).getTime();
      const diff = Math.floor((now - then) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    }

    function openNotifModal(n) {
      if (!n.is_read) {
        markRead(n.id);
      }

      let existing = document.getElementById('notifModal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.id = 'notifModal';
      modal.className = 'fixed inset-0 z-[200] flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeNotifModal()"></div>
        <div class="relative w-full max-w-lg bg-[#0d1321] border border-white/10 rounded-2xl shadow-2xl overflow-hidden animate-modal-in">
          <div class="flex items-center justify-between p-4 border-b border-white/10 bg-white/5">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-secondary/20 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
              </div>
              <div>
                <h3 class="font-bold text-sm text-white">${escapeHtml(n.title)}</h3>
                <p class="text-[10px] text-gray-500">From ${escapeHtml(n.sender || 'Admin')} &middot; ${formatDate(n.created_at)}</p>
              </div>
            </div>
            <button onclick="closeNotifModal()" class="p-1.5 rounded-lg hover:bg-white/10 transition text-gray-400 hover:text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="p-5 max-h-[60vh] overflow-y-auto">
            <div class="text-sm text-gray-200 leading-relaxed whitespace-pre-wrap break-words">${formatMessage(n.message)}</div>
          </div>
          <div class="flex items-center justify-between p-4 border-t border-white/10 bg-white/5">
            <span class="text-[10px] text-gray-500">${timeAgo(n.created_at)}</span>
            <button onclick="closeNotifModal()" class="px-4 py-1.5 bg-secondary/20 text-secondary rounded-lg text-xs font-semibold hover:bg-secondary/30 transition">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }

    window.closeNotifModal = function() {
      const modal = document.getElementById('notifModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') window.closeNotifModal?.();
    });

    function formatMessage(text) {
      let safe = escapeHtml(text);
      safe = safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-secondary underline hover:text-secondary/80 break-all">$1</a>');
      safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');
      safe = safe.replace(/\*(.+?)\*/g, '<em>$1</em>');
      safe = safe.replace(/`(.+?)`/g, '<code class="bg-white/10 text-secondary px-1.5 py-0.5 rounded text-xs font-mono">$1</code>');
      return safe;
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    fetchNotifications();
    setInterval(fetchNotifications, 3000);
  }
})();
</script>
<style>
  @keyframes modal-in {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .animate-modal-in { animation: modal-in 0.2s ease-out; }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
</style>
</body>
</html>
